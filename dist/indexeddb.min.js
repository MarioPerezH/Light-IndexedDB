"use strict";require.config({paths:{q:"scripts/q.min",promise:"src/facades/promise",transaction:"src/transaction",crud:"src/crud",database:"src/database",factory:"src/factory",util:"src/utils"}});var IndexedDB;!function(e){var t=function(){function e(e,t,n){this.$q=e,this.$transaction=t,this.$utils=n}return e.prototype.setConfig=function(e,t){this.config={name:e,version:t}},e.prototype.create=function(e,t){var n=this.$q.defer();return this.$transaction.getTransactionDB(this.config.name,this.config.version,[e],"readwrite",function(e){var r=e[0].add(t);r.onsuccess=function(e){n.resolve(e.target.result)},r.onerror=function(e){n.reject(e)}}),n.promise},e.prototype.read=function(e,t){var n=this.$q.defer();return t||(t=function(){return!0}),Array.isArray(e)||(e=[e]),this.$transaction.getTransactionDB(this.config.name,this.config.version,e,"readwrite",function(r){var o=[],i=0,c=r.length;r.forEach(function(r){var a=r.openCursor(),s=[];a.onsuccess=function(r){var a=r.target.result;if(a)s.push(a.value),a.continue();else if(o.push(s),++i===c)return void(1===e.length?n.resolve(o[0].filter(t)):n.resolve(o))},a.onerror=function(e){n.reject(e)}})}),n.promise},e.prototype.update=function(e,t,n){var r=this,o=this.$q.defer(),i=null,c=[],a=this.$q.defer();return isNaN(+t)?(i=function(e){var t=e[0],i=c.length-1;c.length?c.forEach(function(e,c){r.$utils.extendObject(e,n),n[t.keyPath]=e[t.keyPath];var a=t.put(e);a.onsuccess=function(e){c===i&&o.resolve(!0)},a.onerror=function(e){o.reject(e)}}):o.resolve(!0)},this.$q.when(this.read(e,t)).then(function(e){return c=e}).then(function(){return a.resolve(!0)})):(i=function(e){var i=e[0],c=i.get(t);c.onsuccess=function(e){var c=e.target.result;if(c){r.$utils.extendObject(c,n),c[i.keyPath]=t;var a=i.put(c);a.onsuccess=function(e){o.resolve(!0)},a.onerror=function(e){o.reject(e)}}else o.reject("IndexedDB: No se logró encontrar el indice "+t+" para ser actualizado")},c.onerror=function(e){o.reject(e)}},a.resolve(!0)),this.$q.when(a.promise).then(function(t){return r.$transaction.getTransactionDB(r.config.name,r.config.version,[e],"readwrite",i)}),o.promise},e.prototype.delete=function(e,t){var n=this,r=this.$q.defer(),o=null,i=[],c=this.$q.defer();return isNaN(+t)?(o=function(e){var t=e[0],n=(t.openCursor(),i.length-1);i.length?i.forEach(function(e,o){var i=e[t.keyPath],c=t.delete(i);c.onsuccess=function(e){o===n&&r.resolve(!0)},c.onerror=function(e){r.reject(e)}}):r.resolve(!0)},this.$q.when(this.read(e,t)).then(function(e){return i=e}).then(function(){return c.resolve(!0)})):(o=function(e){var n=e[0],o=(n.openCursor(),n.delete(t));o.onsuccess=function(e){r.resolve(!0)},o.onerror=function(e){r.reject(e)}},c.resolve(!0)),this.$q.when(c.promise).then(function(t){return n.$transaction.getTransactionDB(n.config.name,n.config.version,[e],"readwrite",o)}),r.promise},e}();e.CRUD=t,define(["promise","transaction","utils"],function(e,n,r){return new t(e,n,r)})}(IndexedDB||(IndexedDB={}));var IndexedDB;!function(e){var t=function(){function e(e,t,n){this.$q=e,this.$factory=t,this.$crud=n}return e.prototype.getDataBase=function(e,t){var n=this.$factory.getInstance(this.$crud);return n.setConfig(e,t),n},e.prototype.generateDataBase=function(e,t,n){var r=this,o=this.$q.defer();e&&t||o.reject("No se ha especificado una configuración para la base de datos"),(n||[]).length||o.reject("No se ha especificado stores a crear");var i=this.$factory.getIndexedDB().open(e,t);return i.onsuccess=function(e){o.resolve(!0)},i.onupgradeneeded=function(e){var t=e.target.result;r.updateDataBase(t,n),o.resolve(!0)},i.onerror=function(e){o.reject(e)},o.promise},e.prototype.updateDataBase=function(e,t){if(e.objectStoreNames.length){t.forEach(function(t){e.objectStoreNames.contains(t.name)||e.createObjectStore(t.name,{keyPath:t.primaryKey,autoIncrement:!0})});for(var n=0,r=e.objectStoreNames.length-1;n<=r;n++)!function(){var r=e.objectStoreNames.item(n)||"";t.filter(function(e){return e.name===r})[0]||e.deleteObjectStore(r)}()}else t.forEach(function(t){e.createObjectStore(t.name,{keyPath:t.primaryKey,autoIncrement:!0})})},e.prototype.deleteDataBase=function(e){var t=this.$factory.getIndexedDB().deleteDatabase(e),n=this.$q.defer();return t.onsuccess=function(e){n.resolve(!0)},t.onerror=function(e){n.reject(e)},n.promise},e}();define(["promise","factory","crud"],function(e,n,r){return new t(e,n,r)})}(IndexedDB||(IndexedDB={}));var IndexedDB;!function(e){var t=function(){function e(){}return e.prototype.getInstance=function(e){return Object.create(e)},e.prototype.getIndexedDB=function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},e}();define([],function(){return new t})}(IndexedDB||(IndexedDB={}));var IndexedDB;!function(e){var t=function(){function e(e){this.$factory=e}return e.prototype.getTransactionDB=function(e,t,n,r,o){var i=this.$factory.getIndexedDB().open(e,t);i.onsuccess=function(e){var t=e.target.result.transaction(n,r);o(n.map(function(e){return t.objectStore(e)}))},i.onerror=function(t){console.error("No se ha logrado conectar con "+e+"-"+n,t)}},e}();define(["factory"],function(e){return new t(e)})}(IndexedDB||(IndexedDB={}));var IndexedDB;!function(e){var t=function(){function e(){}return e.prototype.extendObject=function(e,t){var n=this;return Object.keys(t).forEach(function(r){void 0===t[r]||null===t[r]?delete e[r]:"object"!=typeof t[r]||Array.isArray(t[r])?e[r]=t[r]:(("object"!=typeof e[r]||Array.isArray(e[r]))&&(e[r]={}),n.extendObject(e[r],t[r]))}),e},e}();define([],function(){return new t})}(IndexedDB||(IndexedDB={}));